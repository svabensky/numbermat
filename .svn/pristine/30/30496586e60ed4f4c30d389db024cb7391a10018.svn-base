package Numbermat;

import de.nixosoft.jlr.JLRGenerator;
import de.nixosoft.jlr.JLROpener;
import java.awt.Color;
import java.awt.Graphics2D;
import java.awt.Insets;
import java.awt.image.BufferedImage;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import javax.swing.JLabel;
import org.scilab.forge.jlatexmath.TeXConstants;
import org.scilab.forge.jlatexmath.TeXFormula;
import org.scilab.forge.jlatexmath.TeXIcon;

/**
 *
 * @author Valdemar Svabensky <395868@mail.muni.cz>
 */
public class Utils {
    
    public static final String NEWLINE = System.lineSeparator();
    
    /**
     * Processes a LaTeX input to create an image of the formula.
     * Created image can be rendered or saved with ImageIO.
     * 
     * @param LaTeXInput Plaintext formula in LaTeX syntax
     * @return Image containing formula processed by LaTeX, ready to be rendered
     */
    public static BufferedImage createLaTeXImage(String LaTeXInput) {
        try {
            TeXFormula formula = new TeXFormula(LaTeXInput);
            TeXIcon icon = formula.createTeXIcon(TeXConstants.STYLE_DISPLAY, 20);
            icon.setInsets(new Insets(5, 5, 5, 5)); // Borders

            BufferedImage image = new BufferedImage(
                    icon.getIconWidth(),
                    icon.getIconHeight(),
                    BufferedImage.TYPE_INT_ARGB);
            
            Graphics2D g2 = image.createGraphics();
            g2.setColor(Color.white);
            g2.fillRect(0, 0, icon.getIconWidth(), icon.getIconHeight());
            
            JLabel jl = new JLabel();
            jl.setForeground(new Color(0, 0, 0));
            icon.paintIcon(jl, g2, 0, 0);
            return image;
        } catch (Exception ex) {
            System.err.println(ex.getMessage());
            return null;
        }
    }
    
    /**
     * Writes .tex file with mathematical problem and its solution on disk
     * 
     * @param file File to be written to
     * @param problem
     * @param solution
     */
    public static void writeTeXFile(File file, String problem, String solution) {
        BufferedWriter writer = null;
        try {
            writer = new BufferedWriter(new FileWriter(file));
            writer.write("\\documentclass[12pt,a4paper,oneside,leqno]{article}");
            writer.newLine();
            writer.write("\\usepackage[utf8]{inputenc}");
            writer.newLine();
            writer.write("\\usepackage[czech]{babel}");
            writer.newLine();
            writer.write("\\usepackage[T1]{fontenc}");
            writer.newLine();
            writer.write("\\usepackage{amsmath}");
            writer.newLine();
            writer.write("\\usepackage{amsfonts}");
            writer.newLine();
            writer.write("\\usepackage{amssymb}");
            writer.newLine();
            writer.write("\\begin{document}");
            writer.newLine();
            writer.write("\\noindent Zadání:");
            writer.newLine();
            writer.write(problem);
            writer.newLine();
            writer.write("\\vfill");
            writer.newLine();
            writer.write("\\noindent Řešení:");
            writer.newLine();
            writer.write(solution);
            writer.newLine();
            writer.write("\\end{document}");
        }
        catch(IOException ex) {
            System.err.println(ex.getMessage());
        }
        finally {
            try {
                if (writer != null)
                    writer.close();
            } catch (IOException ex) {
                System.err.println(ex.getMessage());
            }
        }
    }
    
    /**
     * Writes .tex file with mathematical problem and its solution on disk.
     * Runs pdfLaTeX on written file and opens .pdf automatically.
     * 
     * @param workingDir Directory to be written to
     * @param problem
     * @param solution
     */
    public static void exportPDF(File workingDir, String problem, String solution) {
        File input = new File(workingDir.getAbsolutePath() + File.separator + "priklad.tex");
        writeTeXFile(input, problem, solution);
        try {
            JLRGenerator pdfGenerator = new JLRGenerator();
            pdfGenerator.deleteTempFiles(false, true, true);
            if (!pdfGenerator.generate(input, workingDir, workingDir)) { 
                System.out.println(pdfGenerator.getErrorMessage());
            }
            JLROpener.open(pdfGenerator.getPDF());
        } catch (IOException ex) {
            System.err.println(ex.getMessage());
        }
    }
    
    /**
     * Replaces last occurrence of a substring in a string with given replacement.
     * 
     * @param string
     * @param substring
     * @param replacement
     * @return String with replacement
     */
    public static String replaceLast(String string, String substring, String replacement) {
        int index = string.lastIndexOf(substring);
        if (index == -1)
            return string;
        return string.substring(0, index) + replacement
                + string.substring(index+substring.length());
    }
    
    public static void insertLaTeXNewlineSymbol(StringBuilder sb, int beginning, boolean addExtraLine) {
        int newlineIndex = sb.indexOf(NEWLINE, beginning);
        if (addExtraLine) {
            while (newlineIndex != -1) {
                sb.insert(newlineIndex, "\\\\");
                newlineIndex = sb.indexOf(NEWLINE, newlineIndex + 3);
            }
        }
        else {
            while (newlineIndex < sb.lastIndexOf(NEWLINE)) {
                sb.insert(newlineIndex, "\\\\");
                newlineIndex = sb.indexOf(NEWLINE, newlineIndex + 3);
            }
        }
    }
}
